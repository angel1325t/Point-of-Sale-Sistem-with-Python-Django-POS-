{% extends 'empleados/empleado.html' %} 
{% load static %} 
{% block section1 %}

<link rel="stylesheet" href="{% static 'css/product_search.css' %}">
  <div class="grid grid-cols-1 gap-6 p-4 sm:p-6">
    <!-- Panel de productos -->
    <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-4 sm:p-6">
      <div class="flex flex-col lg:flex-row justify-between items-center mb-4 sm:mb-6">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Productos</h2>
        <div class="flex flex-col md:flex-row sm:space-x-2 w-full sm:w-auto mt-2 sm:mt-0">
          <button id="toggle-scanner" class="btn btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
              />
            </svg>
            Escanear QR
          </button>
          <div class="relative w-full sm:w-auto mt-2 sm:mt-0">
            <input type="text" id="search-product" placeholder="Buscar producto..." class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" onkeyup="filterProducts()" />
            <div class="absolute w-full bg-white border mt-1 rounded shadow-md hidden custom-dropdown" id="product-list">
                {% for producto in productos %}
                    <div class="product-item px-3 py-2 hover:bg-gray-100 cursor-pointer">{{ producto.nombre }}</div>
                {% endfor %}
            </div>
            <div id="no-results-message" class="hidden absolute top-full mt-2 right-0 bg-white w-64 p-4 shadow-lg text-center text-red-600 border border-red-500 rounded-lg z-50">
                <button id="close-button" class="absolute top-2 right-2 text-red-600 hover:text-red-800">×</button>
                Producto no encontrado
            </div>
        </div>
        
          
    </div>
      </div>
  
      <div id="scanner-container" class="hidden max-w-2xl mx-auto">
        <div id="reader"></div>
        <div class="mt-4 flex justify-end">
          <button id="close-scanner" class="btn btn-secondary">Cerrar Escáner</button>
        </div>
      </div>
  
      <div class="product-grid" id="products-container">
    <div id="sale-items" class="mb-4 space-y-4">
        <!-- Producto individual -->
        
    </div>
    <p id="empty-sale-message" class="text-gray-500 py-4 text-center">No hay productos agregados</p>
</div>

    
    
  
          <div class="flex justify-between mb-2"><span class="text-gray-600">Subtotal:</span><span id="subtotal" class="font-medium">$0.00</span></div>
          <div class="flex justify-between mb-2"><span class="text-gray-600">ITBIS (18%):</span><span id="tax" class="font-medium">$0.00</span></div>
          <div class="flex justify-between mb-4 text-lg font-semibold"><span>Total:</span><span id="total">$0.00</span></div>
  
          <div class="grid grid-cols-2 gap-3 mb-4">
            <button id="clear-sale" class="btn btn-secondary">Limpiar</button>
            <button id="checkout" class="btn btn-success">Cobrar</button>
          </div>
  
          <div>
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">Método de pago:</span>
              <select id="payment-method" class="border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500">
                <option value="cash">Efectivo</option>
                <option value="card">Tarjeta</option>
                <option value="transfer">Transferencia</option>
              </select>
            </div>
  
            <div id="cash-payment" class="mt-3">
              <label class="block text-gray-600 mb-1">Monto recibido:</label>
              <div class="flex space-x-2">
                <input type="number" id="cash-amount" class="border border-gray-300 rounded px-3 py-2 w-full focus:ring-2 focus:ring-blue-500" placeholder="0.00" />
                <button id="calculate-change" class="btn btn-primary">Calcular</button>
              </div>
              <div id="change-container" class="mt-2 hidden">
                <p class="text-gray-600">Cambio a devolver: <span id="change-amount" class="font-bold">$0.00</span></p>
              </div>
            </div>
          </div>
      </div>
    </div>
<script src="{% static 'js/product_search.js' %}"></script>
<script src="https://unpkg.com/html5-qrcode" defer></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Contador para generar IDs únicos para cada producto añadido
    let productCounter = 0;

    const scannerContainer = document.getElementById("scanner-container");
    const toggleScannerButton = document.getElementById("toggle-scanner");
    const closeScannerButton = document.getElementById("close-scanner");
    let qrScanner = new Html5Qrcode("reader");

    toggleScannerButton.addEventListener("click", function() {
        console.log("Iniciando escáner...");  // Depuración
        scannerContainer.classList.remove("hidden");

        if (qrScanner) {
            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 300, height: 300 } },
                async (decodedText) => {
                    console.log("Contenido QR:", decodedText);  // Depuración

                    let productId = null;
                    try {
                        const parsedData = JSON.parse(decodedText);  // Parsear el JSON del QR
                        productId = parsedData.id;  // Obtener solo el id
                    } catch (err) {
                        console.error("Error al parsear QR:", err);
                        alert("El código QR no es válido");
                        qrScanner.stop();
                        scannerContainer.classList.add("hidden");
                        return;
                    }

                    console.log("ID escaneado:", productId);  // Verifica que el ID sea correcto

                    // Realizar petición AJAX para obtener el producto
                    fetch(`/empleados/get-producto/${productId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            
                            // Generar un identificador único para este producto
                            productCounter++;
                            const uniqueId = `${productId}-${productCounter}`;
                            
                            // Crear elemento del producto y agregarlo al contenedor
                            const productItem = document.createElement('div');
                            productItem.classList.add('product-item');
                            productItem.innerHTML = `
<div class="flex items-center justify-between">
  <div class="flex items-center space-x-4">
    <img src="${data.image}" alt="Producto" class="w-12 h-12 object-cover rounded-md">
    <div>
      <p class="font-semibold">${data.nombre}</p>
      <p class="text-gray-500">${data.descripcion}</p>
    </div>
  </div>
  <div class="flex items-center space-x-4">
    <p class="text-gray-500 py-2" id="price-${uniqueId}">Precio: $${data.precio}</p>
    <p class="text-gray-500 py-2">Categoría: ${data.categoria}</p>
    <input type="number" value="1" min="1" class="w-16 p-1 border rounded text-center" id="quantity-${uniqueId}">
    <button class="text-red-500 hover:text-red-700" id="remove-${uniqueId}">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>
</div>
<br>
<hr class="border-t border-gray-200 pt-2">
`;

                            document.getElementById('sale-items').appendChild(productItem);

                            // Eliminar el mensaje "No hay productos agregados" cuando se agrega un producto
                            const emptyMessage = document.getElementById('empty-sale-message');
                            if (emptyMessage) {
                                emptyMessage.classList.add('hidden');
                            }

                            // Evento de eliminar producto: solo elimina el producto correspondiente
                            document.getElementById(`remove-${uniqueId}`).addEventListener("click", function() {
                                productItem.remove();  // Elimina solo este producto del DOM
                                // Si no hay más productos, mostrar el mensaje "No hay productos agregados"
                                if (document.getElementById('sale-items').children.length === 0) {
                                    emptyMessage.classList.remove('hidden');
                                }
                                updatePrices();  // Actualizar precios
                            });

                            // Evento de cambio de cantidad: actualiza el precio y luego recalcula totales
                            const quantityInput = document.getElementById(`quantity-${uniqueId}`);
                            quantityInput.addEventListener("input", function() {
                                const quantity = parseInt(quantityInput.value) || 1;
                                const newPrice = data.precio * quantity;
                                document.getElementById(`price-${uniqueId}`).textContent = `Precio: $${newPrice.toFixed(2)}`;
                                updatePrices();  // Actualizar precios
                            });

                            // Actualizar precios luego de agregar el producto
                            updatePrices();
                        })
                        .catch(err => console.error("Error en la petición AJAX:", err));

                    qrScanner.stop();
                    scannerContainer.classList.add("hidden");
                },
                (error) => {
                    console.warn("Error en escaneo QR:", error);
                }
            );
        }
    });

    closeScannerButton.addEventListener("click", function() {
        scannerContainer.classList.add("hidden");
        if (qrScanner) {
            qrScanner.stop().then(() => {
                qrScanner.clear(); // Limpia el lector para reiniciar correctamente
                qrScanner = null; // Se reinicia la instancia para el próximo escaneo
            });
        }
    });

    // Función para calcular y actualizar los valores de subtotal, ITBIS y total
    function updatePrices() {
        let subtotal = 0;
        // Para cada producto, se obtiene el precio mostrado (ya calculado según la cantidad)
        const productItems = document.querySelectorAll('.product-item');
        productItems.forEach(item => {
            const priceElement = item.querySelector('[id^="price-"]');
            if (!priceElement) {
                console.warn("No se encontró el elemento de precio en el producto:", item);
                return;
            }
            const priceText = priceElement.textContent;
            const price = parseFloat(priceText.replace('Precio: $', '').trim());
            subtotal += price;
        });

        // Calcular el ITBIS (18%) y el total
        const tax = subtotal * 0.18;
        const total = subtotal + tax;

        // Actualizar el DOM
        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('total').textContent = `$${total.toFixed(2)}`;
    }
});



</script>


{% endblock section1 %}
